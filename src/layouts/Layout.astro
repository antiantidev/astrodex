---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import SEO from "../components/SEO.astro";
import "../styles/global.css";

interface Props {
  title: string;
  description?: string;
  image?: string;
  type?: "website" | "article";
}

const { title, description, image, type } = Astro.props;
---

<!doctype html>
<html lang="en" class="dark">
  <head>
    <SEO
      title={title}
      description={description}
      image={image}
      type={type}
      canonicalURL={new URL(Astro.url.pathname, Astro.site || Astro.url)}
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <!-- FontAwesome 6 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body class="antialiased selection:bg-primary-500/30 selection:text-white">
    <Header />
    <main class="min-h-screen">
      <slot />
    </main>
    <Footer />

    <!-- Core Scripts -->
    <script
      src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js"
      is:inline></script>
    <script
      src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"
      is:inline></script>
    <script is:inline>
      function initContentEnhancements() {
        // 1. Image Zoom
        if (typeof mediumZoom === "function") {
          mediumZoom(".prose img", {
            background: "#030712e6",
            margin: 24,
          });
        }

        // 2. Admonitions Transformation
        const bq = document.querySelectorAll(".prose blockquote");
        bq.forEach((el) => {
          const children = Array.from(el.children);
          const finalFragments = [];
          let currentAdmonition = null;

          children.forEach((child) => {
            const lines = child.innerHTML.split(/<br\s*\/?>/i);
            lines.forEach((line) => {
              const content = line.trim();
              if (!content) return;

              let type = null;
              let icon = "";
              let title = "";

              if (content.startsWith("Note:")) {
                type = "note";
                icon = '<i class="fa-solid fa-circle-info"></i>';
                title = "Note";
              } else if (content.startsWith("Warning:")) {
                type = "warning";
                icon = '<i class="fa-solid fa-triangle-exclamation"></i>';
                title = "Warning";
              } else if (content.startsWith("Danger:")) {
                type = "danger";
                icon = '<i class="fa-solid fa-circle-exclamation"></i>';
                title = "Danger";
              }

              if (type) {
                const newContent = content.substring(content.indexOf(":") + 1).trim();
                currentAdmonition = document.createElement("div");
                currentAdmonition.className = `admonition admonition-${type} my-6 rounded-xl border-l-[3px] overflow-hidden shadow-xl transition-all duration-300`;
                currentAdmonition.innerHTML = `
                    <div class="admonition-header flex items-center gap-2.5 px-4 py-2 bg-white/[0.03] font-black uppercase tracking-widest text-[9px]">
                        <span class="admonition-icon">${icon}</span>
                        <span>${title}</span>
                    </div>
                    <div class="admonition-content px-4 py-3 text-[13px] leading-relaxed">
                        <p>${newContent}</p>
                    </div>
                `;
                finalFragments.push(currentAdmonition);
                currentAdmonition = null;
              } else if (currentAdmonition) {
                const contentArea = currentAdmonition.querySelector(".admonition-content");
                const p = document.createElement("p");
                p.className = "mt-2";
                p.innerHTML = content;
                contentArea.appendChild(p);
              } else {
                const p = document.createElement("p");
                p.innerHTML = content;
                finalFragments.push(p);
              }
            });
          });

          if (finalFragments.length > 0) {
            const wrapper = document.createDocumentFragment();
            finalFragments.forEach((f) => wrapper.appendChild(f));
            el.parentNode.replaceChild(wrapper, el);
          }
        });

        // 3. Mermaid Diagrams
        if (typeof mermaid !== "undefined") {
          mermaid.initialize({
            startOnLoad: false,
            theme: "dark",
            themeVariables: {
              primaryColor: "#14b8a6",
              primaryTextColor: "#fff",
              primaryBorderColor: "#14b8a6",
              lineColor: "#475569",
              secondaryColor: "#0f172a",
              tertiaryColor: "#020617",
            },
            securityLevel: "loose",
            fontFamily: "Inter",
          });

          const diagrams = document.querySelectorAll(".language-mermaid");
          diagrams.forEach((el, i) => {
            const code = el.innerText;
            const id = `mermaid-diagram-${i}`;
            const container = el.parentElement;
            const wrapper = document.createElement("div");
            wrapper.className = "mermaid-outer-wrapper my-12 group";
            wrapper.innerHTML = `
                <div class="flex items-center justify-between mb-4 px-2">
                    <div class="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest text-slate-500">
                        <i class="fa-solid fa-diagram-project text-primary-500"></i>
                        Architecture Diagram
                    </div>
                </div>
                <div id="${id}" class="mermaid-container flex justify-center bg-midnight/50 backdrop-blur-md p-10 rounded-3xl border border-white/5 shadow-2xl group-hover:border-primary-500/20 transition-all duration-500 overflow-x-auto">
                    ${code}
                </div>
            `;
            container.parentNode.replaceChild(wrapper, container);
            mermaid.run({ nodes: [wrapper.querySelector(".mermaid-container")] });
          });
        }

        // 4. Code Block Copy Buttons
        const codeBlocks = document.querySelectorAll("pre");
        codeBlocks.forEach((block) => {
          if (block.parentElement.classList.contains("code-block-wrapper")) return;
          
          const wrapper = document.createElement("div");
          wrapper.className = "code-block-wrapper group relative shadow-2xl my-8";
          block.parentNode.insertBefore(wrapper, block);
          wrapper.appendChild(block);

          const button = document.createElement("button");
          button.className = "copy-button absolute top-3 right-3 p-2 rounded-lg border border-border-muted bg-surface-mid/80 text-text-muted hover:text-white transition-all opacity-100 md:opacity-0 md:group-hover:opacity-100 z-[60] active:scale-95 backdrop-blur-md shadow-lg";
          button.innerHTML = '<i class="fa-regular fa-copy text-xs"></i>';
          wrapper.appendChild(button);

          button.addEventListener("click", async () => {
            const code = block.querySelector("code");
            const text = code ? code.innerText : block.innerText;
            await navigator.clipboard.writeText(text);
            button.innerHTML = '<i class="fa-solid fa-check text-primary-500"></i>';
            setTimeout(() => {
              button.innerHTML = '<i class="fa-regular fa-copy"></i>';
            }, 2000);
          });
        });
      }

      initContentEnhancements();
      document.addEventListener("astro:after-swap", initContentEnhancements);
    </script>
  </body>
</html>
